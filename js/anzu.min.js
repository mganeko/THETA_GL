/**
 * anzu-js-sdk
 * anzu-js-sdk
 * @version 0.3.0
 * @author Shiguredo Inc.
 * @license MIT
 */
!function(n){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=n();else if("function"==typeof define&&define.amd)define([],n);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.Anzu=n()}}(function(){var n;return function e(n,t,r){function o(a,s){if(!t[a]){if(!n[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(i)return i(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var f=t[a]={exports:{}};n[a][0].call(f.exports,function(e){var t=n[a][1][e];return o(t?t:e)},f,f.exports,e,n,t,r)}return t[a].exports}for(var i="function"==typeof require&&require,a=0;a<r.length;a++)o(r[a]);return o}({1:[function(n,e,t){"use strict";function r(n){return n&&n.__esModule?n:{"default":n}}function o(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function(){function n(n,e){for(var t=0;t<e.length;t++){var r=e[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),a=n("sora-js-sdk"),s=r(a),c=window.mozRTCPeerConnection||window.webkitRTCPeerConnection,u=window.RTCSessionDescription||window.mozRTCSessionDescription;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var f=function(){function n(e){var t=arguments.length<=1||void 0===arguments[1]?{anzuUrl:null,signalingUrl:null}:arguments[1];if(o(this,n),this.anzuUrl=null===t.anzuUrl?"https://anzu.shiguredo.jp/api/":t.anzuUrl,this.signalingUrl=null===t.signalingUrl?"wss://anzu.shiguredo.jp/signaling":t.signalingUrl,"upstream"!==e&&"downstream"!==e){var r=new Error("Role "+e+" is not defined");throw r}this.role=e}return i(n,[{key:"start",value:function(n,e){var t=arguments.length<=2||void 0===arguments[2]?null:arguments[2];if("upstream"===this.role){var r=null===t?{video:!0,audio:!0}:t;return this._startUpstream(n,e,r)}return"downstream"===this.role?this._startDownstream(n,e):void 0}},{key:"_startUpstream",value:function(n,e,t){var r=this,o=function(n){return new Promise(function(e,t){navigator.getUserMedia?navigator.getUserMedia(n,function(n){r.stream=n,e({stream:n})},function(n){t(n)}):t()})},i=function(){return r.sora=new s["default"](r.signalingUrl).connection(),r.sora.connect({role:"upstream",channelId:n,accessToken:e})},a=function(n){return r.sdplog("Upstream Offer",n),new Promise(function(e,t){r.clientId=n.clientId,r.pc=new c({iceServers:n.iceServers}),r.pc.addStream(r.stream),e(n)})},f=function(n){return new Promise(function(e,t){r.pc.setRemoteDescription(new u(n),function(){r.pc.createAnswer(function(o){r.sdplog("Upstream answer",n),r.pc.setLocalDescription(o,function(){r.sora.answer(o.sdp),r.pc.onicecandidate=function(n){null!==n.candidate&&(console.info("====== candidate ======"),console.info(n.candidate),r.sora.candidate(n.candidate))},e({clientId:r.clientId,stream:r.stream})},function(n){t(n)})},function(n){t(n)})},function(n){t(n)})})};return o(t).then(i).then(a).then(f)}},{key:"_startDownstream",value:function(n,e){var t=this,r=function(){return t.sora=new s["default"](t.signalingUrl).connection(),t.sora.connect({role:"downstream",channelId:n,accessToken:e})},o=function(n){return t.sdplog("Downstream offer",n),new Promise(function(e,r){t.clientId=n.clientId,t.pc=new c({iceServers:n.iceServers}),e(n)})},i=function(n){var e=void 0!==navigator.mozGetUserMedia;return new Promise(function(r,o){e||(t.pc.onaddstream=function(n){t.stream=n.stream}),t.pc.setRemoteDescription(new u(n),function(){t.pc.createAnswer(function(i){t.sdplog("Downstream answer",n),t.pc.setLocalDescription(i,function(){t.sora.answer(i.sdp),t.sendanswer=!0,e?t.pc.onaddstream=function(n){t.stream=n.stream,r({clientId:t.clientId,stream:t.stream})}:r({clientId:t.clientId,stream:t.stream}),t.pc.onicecandidate=function(n){null!==n.candidate&&(console.info("====== candidate ======"),console.info(n.candidate),t.sora.candidate(n.candidate))}},function(n){o(n)})},function(n){o(n)})},function(n){o(n)})})};return r().then(o).then(i)}},{key:"sdplog",value:function(n,e){console.info("========== "+n+" ==========");for(var t in e)console.info(t+":"),console.info(e[t])}}]),n}();e.exports=f},{"sora-js-sdk":2}],2:[function(e,t,r){(function(o){!function(e){if("object"==typeof r&&"undefined"!=typeof t)t.exports=e();else if("function"==typeof n&&n.amd)n([],e);else{var i;i="undefined"!=typeof window?window:"undefined"!=typeof o?o:"undefined"!=typeof self?self:this,i.Sora=e()}}(function(){return function n(t,r,o){function i(s,c){if(!r[s]){if(!t[s]){var u="function"==typeof e&&e;if(!c&&u)return u(s,!0);if(a)return a(s,!0);var f=new Error("Cannot find module '"+s+"'");throw f.code="MODULE_NOT_FOUND",f}var l=r[s]={exports:{}};t[s][0].call(l.exports,function(n){var e=t[s][1][n];return i(e?e:n)},l,l.exports,n,t,r,o)}return r[s].exports}for(var a="function"==typeof e&&e,s=0;s<o.length;s++)i(o[s]);return i}({1:[function(n,e,t){"use strict";function r(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}var o=function(){function n(n,e){for(var t=0;t<e.length;t++){var r=e[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),i=function(){function n(e){r(this,n),this.url=e||""}return o(n,[{key:"connection",value:function(){return new a(this.url)}}]),n}(),a=function(){function n(e){r(this,n),this._ws=null,this._url=e}return o(n,[{key:"connect",value:function(n){var e=this;return new Promise(function(t,r){null===e._ws&&(e._ws=new WebSocket(e._url)),e._ws.onopen=function(){var t=JSON.stringify({type:"connect",role:n.role,channelId:n.channelId,accessToken:n.accessToken});e._ws.send(t)},e._ws.onclose=function(n){4401===n.code&&r(n)},e._ws.onmessage=function(n){var r=JSON.parse(n.data);"offer"==r.type?t(r):"ping"==r.type&&e._ws.send(JSON.stringify({type:"pong"}))}})}},{key:"answer",value:function(n){this._ws.send(JSON.stringify({type:"answer",sdp:n}))}},{key:"candidate",value:function(n){var e=n.toJSON();e.type="candidate",this._ws.send(JSON.stringify(e))}}]),n}();e.exports=i},{}]},{},[1])(1)})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1])(1)});